# План: Финальная зачистка и исправление ошибок в движке композиции

Этот документ содержит финальный план работ по рефакторингу и исправлению ошибок в файле `composer.py`.

### Файл для модификации

- `src/promptscribe/composer.py`

### Высокоуровневая цель

После длительной отладки мы пришли к более надежной архитектуре. Необходимо внести финальные изменения, которые сделают систему более предсказуемой и удобной, а также очистить код от временных отладочных инструкций.

### Детальный план работ

Нужно выполнить следующие четыре шага, желательно за одну операцию `write_file` или `replace` для всего файла.

**1. Удалить все отладочные `print()`**

   - **Задача:** Полностью очистить код от временных `print("DEBUG: ...")`, которые были добавлены в методы `_resolve_variables`, `_substitute_variables` и `_run_simple_assembly`.

**2. Изменить логику подстановки переменных (Ключевой пункт)**

   - **Проблема:** Текущий метод `_substitute_variables` при обнаружении неизвестной переменной (например, `${VAR}` в файле `ARCHITECTURE.md`) удаляет ее, заменяя на пустую строку. Это "портит" содержимое файла, если синтаксис `${...}` используется для других целей.
   - **Решение:** Изменить внутреннюю функцию `replacer` в методе `_substitute_variables`. Если переменная не найдена в конфигурации, функция должна возвращать `match.group(0)`, то есть исходную найденную строку (например, `${VAR}`), а не пустую строку `""`.

**3. Улучшить предупреждение о неизвестной переменной (Особое внимание!)**

   - **Проблема:** В ходе отладки мы выяснили, что предупреждение `Variable not found: 'VAR'` неинформативно, так как мы не видим реальное имя переменной. 
   - **Решение:** Необходимо изменить текст предупреждения на более конкретный и, что важно, использовать безопасный способ формирования строки, который точно отобразит имя переменной. Заменить старое предупреждение на новое:
     ```python
     ui.warning(f"Variable '${var_name}' found in text but not in config. Leaving it untouched.")
     ```
   - **Обоснование для новой сессии:** Этот шаг критически важен, чтобы в будущем при отладке в консоль выводилось реальное имя переменной (например, `...not in config. Leaving '${my_undefined_var}' untouched.`), а не бесполезный плейсхолдер `'VAR'`.

**4. Исправить двойные переносы строк в режиме `assembly`**

   - **Проблема:** Между некоторыми блоками контента и разделителями в итоговом файле появляется лишняя пустая строка.
   - **Решение:** В конце метода `_run_simple_assembly` необходимо изменить финальную строку сборки. Заменить:
     ```python
     return "\n\n".join(parts)
     ```
     на:
     ```python
     return "\n\n".join(p.strip() for p in parts if p)
     ```
   - **Обоснование:** Это изменение будет удалять лишние пробелы и переносы строк у каждого блока *перед* их объединением, что гарантирует чистое и предсказуемое форматирование с одной пустой строкой между элементами.

**5. Удалить логику `include_raw`**

   - **Задача:** Так как шаг 2 (изменение логики подстановки) делает метод `include` безопасным для любых файлов, отдельный метод `include_raw` больше не нужен.
   - **Решение:** Удалить блок `elif key == 'include_raw': ...` из метода `_run_simple_assembly`.
